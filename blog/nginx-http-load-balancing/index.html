<!DOCTYPE html>
<html lang="en-US"><head><script src="https://www.googletagmanager.com/gtag/js?id=G-9FB8SDTWWP" async=""></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-9FB8SDTWWP`)</script><meta charset="utf-8"><meta content="-673247634" name="ir-site-verification-token"><meta content="index, follow" name="”robots”"><meta content="width=device-width,initial-scale=1" name="viewport"><link href="/styles.css" rel="stylesheet"><link href="" rel="me"><title>HTTP Load Balancing with NGINX</title><meta content="A comprehensive guide walking through HTTP load balancing with NGINX and explains how to distribute requests across multiple backend servers using different methods." name="description"><meta name="theme-color"><meta content="website" name="og:type"><meta content="en_US" name="og:locale"><meta name="og:site_name"><meta content="/images/logos/nginx.webp" name="og:image"><meta content="HTTP Load Balancing with NGINX" name="og:title"><meta content="/blog/nginx-http-load-balancing/" name="og:url"><meta content="A comprehensive guide walking through HTTP load balancing with NGINX and explains how to distribute requests across multiple backend servers using different methods." name="og:description"><meta content="summary_large_image" name="twitter:card"><meta name="twitter:site"><meta name="twitter:creator"><meta content="/images/logos/nginx.webp" name="twitter:image"><meta content="NGINX logo" name="twitter:image:alt"><meta content="HTTP Load Balancing with NGINX" name="twitter:title"><meta content="A comprehensive guide walking through HTTP load balancing with NGINX and explains how to distribute requests across multiple backend servers using different methods." name="twitter:description"><link href="https://referentiallabs.com/blog/nginx-http-load-balancing/" rel="canonical"><link href="/manifest.json" rel="manifest"><link color="#ffffff" href="/favicon.ico" rel="mask-icon"><link href="/favicon.ico" rel="icon"><link href="/apple-touch-icon.webp" rel="apple-touch-icon"><link href="/apple-touch-icon-precompose.webp" rel="apple-touch-icon-precomposed"><meta content="default-src 'self' https://www.googletagmanager.com https://www.google-analytics.com https://fonts.gstatic.com https://js.hsforms.net https://forms.hsforms.com https://www.google.com https://app.hubspot.com https://forms-na1.hsforms.com 'unsafe-inline'" http-equiv="Content-Security-Policy"><meta content="website" property="og:type"><meta content="https://referentiallabs.com/blog/nginx-http-load-balancing/" property="og:url"><meta content="summary" name="twitter:card"></head><body class="bg-white dark:bg-zinc-950 text-zinc-950 dark:text-zinc-50"><header><div class="mx-auto w-screen w-full max-w-3xl md:max-w-4xl lg:max-w-6xl"><div class="flex mx-auto px-6 py-6 md:space-x-10 lg:px-8"><div class="flex-auto justify-start lg:flex-1"><a href="/"> <span class="sr-only">Referential Labs</span> <img alt="Referential Labs logo image in circle" class="aspect-[94/100] bg-white rounded-full p-2 ring-2" height="50" src="/images/logo-sm.webp" width="47"> </a></div><nav class="space-x-2 md:space-x-8 lg:space-x-10 md:flex-auto place-end"><a class="text-base px-2 py-1 md:px-4 md:py-2 m-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/"> Home </a><a class="text-base px-2 py-1 md:px-4 md:py-2 my-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/#benefits"> Benefits </a><a class="text-base px-2 py-1 md:px-4 md:py-2 my-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/#testimonials"> Testimonials </a><a class="text-base px-2 py-1 md:px-4 md:py-2 my-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/#plans"> Plans </a><a class="text-base px-2 py-1 md:px-4 md:py-2 my-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/#faqs"> FAQ </a><a class="text-base px-2 py-1 md:px-4 md:py-2 my-auto font-medium text-stone-600 dark:text-stone-200 hover:rounded-lg hover:no-underline hover:ring-2 hover:ring-green-800 hover:dark:ring-green-100" href="/blog">Blog</a></nav></div></div></header><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": { "@id": "/blog", "name": "Blog" }
    }
  ]
}
</script><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "@id": "/blog/nginx-http-load-balancing/#BlogPosting",
    "mainEntityOfPage": "/blog/nginx-http-load-balancing/",
    "headline": "HTTP Load Balancing with NGINX",
    "name": "HTTP Load Balancing with NGINX",
    "description": "A comprehensive guide walking through HTTP load balancing with NGINX and explains how to distribute requests across multiple backend servers using different methods.",
    "datePublished": "2023-07-30T19:00:00-05:00",
    "author": {
      "@type": "Person",
      "@id": "/about#susan-potter",
      "url": "/about#susan-potter",
      "name": "Susan Potter"
    },
    "image": {
      "@type": "ImageObject",
      "@id": "/images/spotter.webp",
      "url": "/images/spotter.webp",
      "height": "600",
      "width": "480"
    },
    "url": "/blog/nginx-http-load-balancing/"
  }
</script><main class="max-w-3xl md:max-w-4xl lg:max-w-6xl xl:max-w-7xl mx-auto w-full px-3"><article class="prose"><h1 class="text-2xl font-bold">HTTP Load Balancing with NGINX</h1><p class="text-base front-light">6 minutes read (1450 words)</p><p class="text-base font-light italic pb-3 border-b border-stone-300">July 30th, 2023</p><div><img alt="NGINX logo" class="w-5/6 mx-auto aspect-[100/115]" height="635" src="/images/logos/nginx.webp" width="844"><div class="prose"><p>For the last twelve years, I have been using NGINX to provide load balancing solutions for web applications. In this post I wanted to document ways of setting up HTTP load balancing via NGINX and some common considerations you should make with your web application needs in mind. By the end of this post, you should have a good understanding of how to use NGINX to easily distribute requests across multiple servers for many cases. However, if you are having a hard time figuring out in an evidence backed method the most effective approach for your web application feel free to explore <a href="/#plans">our plans which you can pause at any time</a> between available work.</p><p>Load balancing is one of those unsung hero techniques that keeps the internet running smoothly. The goal is simple - take incoming requests and spread them evenly across a group of servers. But the benefits are huge:</p><ul><li>Improve resource utilization by removing idle servers and overworked servers.</li><li>Maximize throughput by allowing more requests to be handled at once.</li><li>Reduce latency by routing each request to the server that can respond the quickest.</li><li>Ensure fault tolerance by quickly shifting traffic away from unhealthy servers.</li></ul><p>NGINX is a popular open source web server that also excels as a load balancer. It's blazingly fast, highly customizable, and capable of handling enormous loads with minimal resource usage.</p><p>Here we'll cover the core load balancing techniques offered by NGINX. I'll explain each concept in simple terms with easy-to-understand examples. My goal is to provide a friendly introduction to get you load balancing like a pro!</p><h2>Load Balancing Basics</h2><p>Before diving into NGINX specifics, let's quickly distinguish between Layer 4 and Layer 7 load balancing. These terms refer to different levels of the OSI networking model:</p><ul><li>Layer 4 load balancers work at the transport layer, looking only at IP addresses and ports. They balance incoming TCP connections across backend servers.</li><li>Layer 7 load balancers work at the application layer, looking at HTTP headers and content. They route complete HTTP requests to backends. Layer 4 load balancing requires less processing overhead, so it can handle more throughput. But Layer 7 provides more flexibility to control how requests are distributed.</li></ul><p>NGINX can do both Layer 4 and Layer 7 balancing, but we'll focus on Layer 7 HTTP load balancing in this guide. HTTP is slower but offers advanced traffic control for modern web applications.</p><p>Now that we've got the basics down, let's look at configuring HTTP load balancing with NGINX!</p><h2>HTTP Load Balancing with NGINX</h2><p>The first step is to create an upstream block describing our group of backend servers:</p><pre><code class="language-nginx hljs"><span class="hljs-section">http</span> {
  <span class="hljs-section">upstream</span> myapp {
    <span class="hljs-attribute">server</span> app1.example.com;
    <span class="hljs-attribute">server</span> app2.example.com;
    <span class="hljs-attribute">server</span> app3.example.com; 
  }
}
</code></pre><p>This block is named "myapp" and contains three backend servers. We can reference this group from any NGINX virtual server blocks that need to load balance requests.</p><p>NGINX will distribute requests to these servers in <em>round robin</em> fashion by default. Each server gets an equal number of requests sent its way though the load distribution incurred by each request may be uneven across nodes.</p><p><img alt="&quot;Round robin flow&quot;" src="/images/blog-nginx-round-robin-flow.webp"></p><p>But we can easily change the distribution method to suit our needs. Here are some other algorithms NGINX supports:</p><dl><dt>Least Connections</dt><dd>Send each request to the backend server with the least number of active connections. Great for balancing uneven loads.</dd></dl><p><img alt="&quot;Least Connections flow&quot;" src="/images/blog-nginx-least-connections-flow.webp"></p><dl><dt>IP Hash</dt><dd>Hash the client IP to always pick the same backend server. Useful for session persistence.</dd></dl><p><img alt="&quot;IP Hash flow&quot;" src="/images/blog-nginx-ip-hash-flow.webp"></p><dl><dt>Generic Hash</dt><dd>Hash a custom key to select the backend server. Allows advanced traffic shaping.</dd></dl><p><img alt="&quot;Hash flow&quot;" src="/images/blog-nginx-cookie-hash-flow.webp"></p><dl><dt>Random</dt><dd>Select a random backend server for each request. Improves cache utilization with multiple load balancers.</dd></dl><p>The possibilities are endless! And we've barely scratched the surface of NGINX's flexible load balancing capabilities.</p><p>Now let's look at controlling the proportion of requests allocated to each server. The <strong>weight</strong> parameter lets us bias distribution towards certain backends:</p><pre><code class="language-nginx hljs"><span class="hljs-section">upstream</span> myapp {
  <span class="hljs-attribute">server</span> app1.example.com weight=<span class="hljs-number">3</span>;
  <span class="hljs-attribute">server</span> app2.example.com;
  <span class="hljs-attribute">server</span> app3.example.com;
}
</code></pre><p>Here app1 will receive 3x as many requests as the other two servers. Weight values are relative, so we can achieve different distributions like 2:1:1 or 1:2:5 easily.</p><p>Session persistence is another common requirement, so the client keeps connecting to the same backend during their session. NGINX provides a simple <strong>sticky cookie</strong> method:</p><pre><code class="language-nginx hljs"><span class="hljs-section">upstream</span> myapp {
  <span class="hljs-attribute">sticky</span> cookie srv_id expires=<span class="hljs-number">1h</span> domain=.mydomain.com path=/;

  <span class="hljs-attribute">server</span> app1.example.com;
  <span class="hljs-attribute">server</span> app2.example.com;
}
</code></pre><p>The first backend server to receive a request from a client will set the "srv_id" cookie, mapping the session to itself. Future requests will read this cookie and return to the original backend. Perfect for shopping carts and user sessions!</p><h2>Health Checks</h2><p>Of course, servers sometimes fail. NGINX provides passive health checks to gracefully handle outages.</p><p>The <strong>max_fails</strong> and <strong>fail_timeout</strong> parameters control when a server is marked down:</p><pre><code class="language-nginx hljs"><span class="hljs-section">upstream</span> myapp {
  <span class="hljs-attribute">server</span> app1.example.com max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
  <span class="hljs-attribute">server</span> app2.example.com;
  <span class="hljs-attribute">server</span> app3.example.com; 
}
</code></pre><p>Here app1 will be considered unhealthy after 2 failures within 30 seconds. NGINX will stop sending it requests until it recovers.</p><p>We can also gradually ramp up traffic to a server that was marked down, using the <strong>slow_start</strong> parameter:</p><pre><code class="language-nginx hljs"><span class="hljs-section">upstream</span> myapp {
  <span class="hljs-attribute">server</span> app1.example.com slow_start=<span class="hljs-number">30s</span>;
  <span class="hljs-attribute">server</span> app2.example.com;
  <span class="hljs-attribute">server</span> app3.example.com;
} 
</code></pre><p>Now app1 will take 30 seconds to warm up when recovering before handling full production loads. This prevents it from being overwhelmed.</p><h2>DNS-Based Load Balancing</h2><p>Manually keeping the upstream block in sync with backend servers is tedious. Instead, we can use DNS to automatically provide NGINX with the current backend IP addresses.</p><p>First, configure DNS resolution:</p><pre><code class="language-nginx hljs"><span class="hljs-section">http</span> {
  <span class="hljs-attribute">resolver</span> <span class="hljs-number">10.0.0.2</span> valid=<span class="hljs-number">300s</span>; 

  <span class="hljs-section">upstream</span> myapp {
    <span class="hljs-attribute">zone</span> myapp <span class="hljs-number">64k</span>;
    <span class="hljs-attribute">server</span> backend1.example.com resolve;
    <span class="hljs-attribute">server</span> backend2.example.com resolve;
  }
}
</code></pre><p>The <strong>resolver</strong> directive points NGINX at our DNS server. Each <strong>server</strong> entry has the <strong>resolve</strong> parameter set.</p><p>Now when the DNS record for backend1/2 changes, NGINX will automatically apply the updated IP address list for load balancing. No restarts or reconfigs needed!</p><h2>Health Checks In-Depth</h2><p>Now that we've covered the fundamentals, let's do a quick deep dive on health checks.</p><p>We discussed passive health checks earlier - NGINX silently monitors backend connections and marks down servers when failures exceed the <strong>max_fails</strong> threshold.</p><p>For a more active approach, external tools like Consul or Pingdom can explicitly probe each backend and provide health status back to NGINX. This gives us more visibility and control compared to passive monitoring.</p><p>When integrating NGINX with active health checks, the <strong>slow_start</strong> parameter is invaluable:</p><pre><code class="language-nginx hljs"><span class="hljs-section">upstream</span> myapp {
  <span class="hljs-attribute">server</span> app1.example.com slow_start=<span class="hljs-number">30s</span>;
  <span class="hljs-attribute">server</span> app2.example.com;
  <span class="hljs-attribute">server</span> app3.example.com;
}
</code></pre><p>By gradually ramping up traffic to newly recovered servers, we protect them from being overwhelmed by a flood of connections.</p><p>Overall, a combination of passive and active checks provides the best reliability and visibility. NGINX handles passive checks automatically, while external tools give deeper health insight with custom probes.</p><h2>Best Practices</h2><p>We've covered a ton of ground already! To wrap up, here are some key tips for load balancing success:</p><ul><li>Monitor key backend metrics - requests/sec, latency, errors. Identify unhealthy servers early.</li><li>Tune health check intervals and thresholds for your app. Aggressive checks can degrade performance.</li><li>Use an auto scaling group with multiple backend AMIs. NGINX can automatically scale up.</li><li>Regularly test failover by disabling backends. Validate the system dynamically adapts.</li><li>Implement DNS-based server changes or an API for backend management. Automate everything!</li><li>There is no one-size-fits-all solution. Experiment with different combinations of methods based on your traffic patterns.</li><li>Continuously inspect metrics and logs for improvements. Load balancing is a recursive optimization problem.</li></ul><h2>Load Balancing Techniques Comparison</h2><table><thead><tr><th>Method</th><th>Key Benefit</th><th>Key Drawback</th></tr></thead><tbody><tr><td>Round Robin</td><td>Simple, equal distribution</td><td>Can overload servers with uneven request types</td></tr><tr><td>Least Connections</td><td>Adapts to uneven loads</td><td>More state overhead</td></tr><tr><td>IP Hash</td><td>Session persistence</td><td>Uneven if sessions differ</td></tr><tr><td>Cookie Hash</td><td>Persistence without state</td><td>Extra latency from hashing</td></tr><tr><td>Health Checks</td><td>Fast failure detection</td><td>Complex behaviors while flapping or brown outs</td></tr><tr><td>DNS Load Balancing</td><td>Dynamic config</td><td>DNS dependency</td></tr></tbody></table><p>Congratulations, you made it! You now understand the core considerations for load balancing with NGINX. The concepts are easy, but the combinations can get complex for large scale web apps.</p><p>The great part is NGINX gives you simple building blocks that you can start combining using your own creative problem-solving. Keep iterating and improving based on data, and you will be a load balancing pro in no time!</p></div></div></article></main><footer class="bg-white dark:bg-zinc-950"><div class="mx-auto max-w-7xl overflow-hidden"><div class="mt-4 flex justify-center space-x-10"><a class="text-stone-500 dark:text-stone-200 hover:text-green-700" href="https://www.linkedin.com/company/10681458"> <span class="sr-only">LinkedIn</span> <svg class="h-6 w-6" viewbox="0 0 24 24" aria-hidden="true" fill="currentColor"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect height="12" width="4" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg> </a><a class="text-stone-500 dark:text-stone-200 hover:text-green-700" href="https://twitter.com/referentiallabs"> <span class="sr-only">Twitter</span> <svg class="h-6 w-6" viewbox="0 0 24 24" aria-hidden="true" fill="currentColor"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg> </a><a class="text-stone-500 dark:text-stone-200 hover:text-green-700" href="https://github.com/referentiallabs"> <span class="sr-only">GitHub</span> <svg class="h-6 w-6" viewbox="0 0 24 24" aria-hidden="true" fill="currentColor"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" fill-rule="evenodd"></path></svg> </a></div><p class="mt-2 md:mt-4 text-center text-xs leading-5 text-stone-600 dark:text-stone-200">© - Referential Labs LLC. All rights reserved.</p></div></footer></body></html>